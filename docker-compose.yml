# version: "3.9"

# services:
#   firewall:
#     build: 
#       context: .
#       dockerfile: ./firewall/Dockerfile
#     container_name: iptables_firewall
#     privileged: true
#     networks:
#       client_net:
#         ipv4_address: 10.10.0.20
#       server_net:
#         ipv4_address: 10.20.0.20
#     tty: true
#     volumes:
#       - ./app:/app
#       - ./db:/db
#       - ./tests:/tests
#       - ~/.ssh/id_rsa.pub:/root/.ssh/authorized_keys:ro

#   client:
#     image: alpine
#     container_name: client_box
#     command: sh -c "apk add curl iproute2 iputils && sleep infinity"
#     networks:
#       client_net:
#         ipv4_address: 10.10.0.10

#   server:
#     image: nginx:latest
#     container_name: web_server
#     networks:
#       server_net:
#         ipv4_address: 10.20.0.30

# networks:
#   client_net:
#     driver: bridge
#     ipam:
#       config:
#         - subnet: 10.10.0.0/24
#   server_net:
#     driver: bridge
#     ipam:
#       config:
#         - subnet: 10.20.0.0/24


# version: "3.9"

# services:
#   firewall:
#     build:
#       context: ./firewall
#       dockerfile: Dockerfile
#     container_name: iptables_firewall
#     privileged: true
#     tty: true
#     networks:
#       - iptables_net
#     # ports:
#     #   - "2222:22"   # Map host port 2222 â†’ container port 22 for SSH access
#     volumes:
#       # Mount SSH public key into container
#       - ~/.ssh/id_rsa.pub:/root/.ssh/authorized_keys:ro
#       # Mount app code and db for live updates
#       - ./app:/app
#       - ./db:/db
#     command: ["/usr/sbin/sshd", "-D"]

#   client:
#     image: ubuntu:22.04
#     container_name: iptables_client
#     tty: true
#     networks:
#       - iptables_net
#     depends_on:
#       - firewall

#   server:
#     image: ubuntu:22.04
#     container_name: iptables_server
#     tty: true
#     networks:
#       - iptables_net
#     depends_on:
#       - firewall

# networks:
#   iptables_net:
#     driver: bridge


# version: "3.9"

# services:
#   firewall:
#     build:
#       context: ./firewall
#       dockerfile: Dockerfile
#     container_name: iptables_firewall
#     privileged: true
#     tty: true
#     networks:
#       iptables_net:
#         ipv4_address: 10.10.0.20
#     volumes:
#       # Mount SSH key for key-based auth
#       - /home/glitch/.ssh/id_rsa.pub:/root/.ssh/authorized_keys:ro
#       # Mount app and db for live development
#       - ./app:/app
#       - ./db:/db
#       - ./tests:/tests
#     command: ["/usr/sbin/sshd", "-D"]

#   client:
#     image: ubuntu:22.04
#     container_name: iptables_client
#     tty: true
#     networks:
#       iptables_net:
#         ipv4_address: 10.10.0.30
#     depends_on:
#       - firewall

#   server:
#     image: ubuntu:22.04
#     container_name: iptables_server
#     tty: true
#     networks:
#       iptables_net:
#         ipv4_address: 10.10.0.40
#     depends_on:
#       - firewall

# networks:
#   iptables_net:
#     driver: bridge
#     ipam:
#       config:
#         - subnet: 10.10.0.0/24


version: "3.9"

services:
  base:
    build:
      context: ./base
    image: iptables_base:latest

  firewall:
    build:
      context: ./firewall
    container_name: iptables_firewall
    depends_on:
      - base
    privileged: true
    tty: true
    networks:
      ip_tables_gui_iptables_net:
        ipv4_address: 10.10.0.20
    volumes:
      # - ${HOME}/.ssh/id_rsa.pub:/root/.ssh/authorized_keys:ro
      - /home/glitch/.ssh/id_rsa.pub:/root/.ssh/authorized_keys:ro      
      - ./app:/app
      - ./db:/db
    command: ["/usr/sbin/sshd", "-D"]

  client:
    build:
      context: ./client
    container_name: iptables_client
    depends_on:
      - base
    tty: true
    networks:
      ip_tables_gui_iptables_net:
        ipv4_address: 10.10.0.30
    volumes:
      - /home/glitch/.ssh/id_rsa.pub:/root/.ssh/authorized_keys:ro

  server:
    build:
      context: ./server
    container_name: iptables_server
    depends_on:
      - base
    tty: true
    networks:
      ip_tables_gui_iptables_net:
        ipv4_address: 10.10.0.40
    volumes:
      - /home/glitch/.ssh/id_rsa.pub:/root/.ssh/authorized_keys:ro

networks:
  ip_tables_gui_iptables_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.10.0.0/24
